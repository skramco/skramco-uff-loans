{"content":"import \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\nimport { createClient } from \"npm:@supabase/supabase-js@2\";\n\n/**\n * Vesta Webhook Receiver — Channel-Aware Architecture\n *\n * Dispatches: eventType × channel → template + recipients\n *   - Retail  → LO email (from loanOriginator)\n *   - Wholesale → Broker email (from partnerBrokers[].emailAddress)\n *\n * URL: https://pvzqgboffydqeqzeiysx.supabase.co/functions/v1/vesta-webhook\n */\n\n// ─── Types ───────────────────────────────────────────────────────────────────\n\ntype Channel = \"Retail\" | \"Wholesale\" | \"Unknown\";\n\ninterface VestaWebhookPayload {\n  id: string;\n  type: string;\n  loanId: string;\n  newLoanStage?: string;\n  loanChannel?: string;\n  sourceType?: string;\n  userId?: string;\n  timestamp?: string;\n  retries?: number;\n  version?: string;\n  [key: string]: any;\n}\n\ninterface VestaConfig {\n  apiUrl: string;\n  apiKey: string;\n  apiVersion: string;\n}\n\ninterface LoanDetails {\n  loanNumber: string;\n  channel: Channel;\n  borrowerName: string;\n  borrowerFirstName: string;\n  borrowerEmail: string;\n  borrowerPhone: string;\n  loFullName: string;\n  loEmail: string;\n  loPhone: string;\n  loNmlsId: string;\n  brokerName: string;\n  brokerEmail: string;\n  brokerCompany: string;\n  brokerPhone: string;\n  brokerNmlsId: string;\n  propertyAddress: string;\n  loanAmount: number | null;\n  loanType: string;\n  loanPurpose: string;\n  loanStage: string;\n  underwriterNote: string;\n  raw: Record\u003cstring, any\u003e;\n}\n\ninterface EmailResult {\n  subject: string;\n  html: string;\n  recipients: string[];\n}\n\n// ─── Helpers ─────────────────────────────────────────────────────────────────\n\nfunction jsonResponse(data: unknown, status = 200) {\n  return new Response(JSON.stringify(data), {\n    status,\n    headers: { \"Content-Type\": \"application/json\" },\n  });\n}\n\nfunction formatCurrency(value: number | undefined | null): string {\n  if (value == null) return \"--\";\n  return new Intl.NumberFormat(\"en-US\", { style: \"currency\", currency: \"USD\", minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);\n}\n\nfunction resolveChannel(webhook: VestaWebhookPayload, loan: LoanDetails | null): Channel {\n  const ch = webhook.loanChannel || loan?.channel || \"\";\n  if (/retail/i.test(ch)) return \"Retail\";\n  if (/wholesale/i.test(ch)) return \"Wholesale\";\n  return \"Unknown\";\n}\n\nfunction formatTimestamp(ts?: string): string {\n  const d = ts ? new Date(ts) : new Date();\n  return d.toLocaleString(\"en-US\", { timeZone: \"America/Chicago\", month: \"short\", day: \"numeric\", year: \"numeric\", hour: \"numeric\", minute: \"2-digit\" }) + \" CT\";\n}\n\n// ─── Vesta API Config ────────────────────────────────────────────────────────\n\nasync function getVestaConfig(): Promise\u003cVestaConfig\u003e {\n  try {\n    const supabase = createClient(Deno.env.get(\"SUPABASE_URL\")!, Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!);\n    const { data } = await supabase.from(\"admin_settings\").select(\"vesta_environment\").eq(\"id\", 1).maybeSingle();\n    const env = data?.vesta_environment || \"dev\";\n    if (env === \"production\") {\n      return {\n        apiUrl: Deno.env.get(\"VESTA_PROD_API_URL\") || \"https://uff.vesta.com/api/v1\",\n        apiKey: Deno.env.get(\"VESTA_PROD_API_KEY\") || \"\",\n        apiVersion: Deno.env.get(\"VESTA_PROD_API_VERSION\") || \"26.1\",\n      };\n    }\n    return {\n      apiUrl: Deno.env.get(\"VESTA_DEV_API_URL\") || \"https://uff.beta.vesta.com/api/v1\",\n      apiKey: Deno.env.get(\"VESTA_DEV_API_KEY\") || Deno.env.get(\"VESTA_API_KEY\") || \"\",\n      apiVersion: Deno.env.get(\"VESTA_DEV_API_VERSION\") || Deno.env.get(\"VESTA_API_VERSION\") || \"26.1\",\n    };\n  } catch {\n    return {\n      apiUrl: Deno.env.get(\"VESTA_API_URL\") || \"https://uff.beta.vesta.com/api/v1\",\n      apiKey: Deno.env.get(\"VESTA_API_KEY\") || \"\",\n      apiVersion: Deno.env.get(\"VESTA_API_VERSION\") || \"26.1\",\n    };\n  }\n}\n\nfunction getVestaLoanUrl(apiUrl: string, loanId: string): string | undefined {\n  if (!apiUrl || !loanId) return undefined;\n  return `${apiUrl.replace(/\\/api\\/v\\d+\\/?$/, \"\")}/loans/${loanId}`;\n}\n\n// ─── Fetch Loan Details ──────────────────────────────────────────────────────\n\nasync function fetchLoanDetails(loanId: string): Promise\u003cLoanDetails | null\u003e {\n  try {\n    const config = await getVestaConfig();\n    if (!config.apiUrl || !config.apiKey) { console.error(\"Vesta API not configured\"); return null; }\n    const baseUrl = config.apiUrl.replace(/\\/+$/, \"\");\n    const loanUrl = `${baseUrl}/loans/${encodeURIComponent(loanId)}`;\n    console.log(`Fetching loan from Vesta: ${loanUrl}`);\n    const response = await fetch(loanUrl, {\n      method: \"GET\",\n      headers: { Accept: \"application/json\", Authorization: `Token ${config.apiKey}`, \"x-Api-Version\": config.apiVersion },\n    });\n    if (!response.ok) { console.error(`Vesta API error (${response.status}): ${await response.text()}`); return null; }\n    const loan = await response.json();\n\n    // Log raw keys for debugging partnerBrokers structure\n    console.log(\"Vesta loan keys:\", Object.keys(loan || {}).join(\", \"));\n    if (loan?.partnerBrokers) console.log(\"partnerBrokers:\", JSON.stringify(loan.partnerBrokers).slice(0, 500));\n\n    const borrower = loan?.borrowers?.[0] || {};\n    const borrowerName = [borrower.firstName, borrower.lastName].filter(Boolean).join(\" \") || \"Borrower\";\n    const borrowerPhone = borrower.phoneNumbers?.find(\n      (p: any) =\u003e p.type?.toLowerCase() === \"mobile\" || p.type?.toLowerCase() === \"cell\"\n    )?.number || borrower.phoneNumbers?.[0]?.number || \"\";\n\n    const lo = loan?.loanOriginator || {};\n    const addr = loan?.subjectProperty?.address || {};\n    const propertyAddress = [addr.line || addr.streetAddress, addr.city, addr.state, addr.zipCode].filter(Boolean).join(\", \");\n    const loanProduct = loan?.loanProduct || {};\n\n    // Extract partner broker info (Wholesale channel)\n    const broker = loan?.partnerBrokers?.[0] || {};\n    const loanChannel = loan?.loanChannel || loan?.channel || \"\";\n\n    return {\n      loanNumber: loan?.loanNumber || \"\",\n      channel: /retail/i.test(loanChannel) ? \"Retail\" : /wholesale/i.test(loanChannel) ? \"Wholesale\" : \"Unknown\",\n      borrowerName,\n      borrowerFirstName: borrower.firstName || borrowerName.split(\" \")[0] || \"there\",\n      borrowerEmail: borrower.email || borrower.emailAddress || \"\",\n      borrowerPhone,\n      loFullName: lo.fullName || lo.name || \"\",\n      loEmail: lo.email || lo.emailAddress || \"\",\n      loPhone: lo.phoneNumber || lo.phone || \"\",\n      loNmlsId: lo.nmlsId || \"\",\n      brokerName: broker.fullName || broker.name || [broker.firstName, broker.lastName].filter(Boolean).join(\" \") || \"\",\n      brokerEmail: broker.emailAddress || broker.email || \"\",\n      brokerCompany: broker.companyName || broker.company || \"\",\n      brokerPhone: broker.phoneNumber || broker.phone || \"\",\n      brokerNmlsId: broker.nmlsId || \"\",\n      propertyAddress,\n      loanAmount: loan?.loanAmount || loanProduct?.loanAmount || null,\n      loanType: loanProduct?.mortgageType || loan?.loanType || \"\",\n      loanPurpose: loan?.loanPurpose || loanProduct?.loanPurpose || \"\",\n      loanStage: loan?.loanStage || loan?.stage || \"\",\n      underwriterNote: loan?.underwriterNote || loan?.underwriterNotes || \"\",\n      raw: loan,\n    };\n  } catch (err: any) {\n    console.error(\"Failed to fetch loan details:\", err.message);\n    return null;\n  }\n}\n\n// ─── Fetch Objective Conditions ──────────────────────────────────────────────\n\ninterface ConditionItem {\n  id: string;\n  entityType: string;\n  conditionTiming: string | null;\n  conditionStatus: string;\n  conditionAtFaultUsers: string[];\n  instructionsOverride: string;\n  conditionCategory?: string;\n  objectiveName?: string;\n  externalFacingMessage?: string;\n  [key: string]: any;\n}\n\nconst TIMING_ORDER = [\"PriorToApproval\", \"PriorToDocs\", \"PriorToClosing\", \"PriorToFunding\", \"PostFunding\"];\nconst TIMING_LABELS: Record\u003cstring, string\u003e = {\n  PriorToApproval: \"Prior to Approval\",\n  PriorToDocs: \"Prior to Docs\",\n  PriorToClosing: \"Prior to Closing\",\n  PriorToFunding: \"Prior to Funding\",\n  PostFunding: \"Post Funding\",\n};\n\nfunction groupConditionsByTiming(conditions: ConditionItem[]): { timing: string; label: string; items: ConditionItem[] }[] {\n  const groups: Record\u003cstring, ConditionItem[]\u003e = {};\n  for (const c of conditions) {\n    const key = c.conditionTiming || \"Other\";\n    if (!groups[key]) groups[key] = [];\n    groups[key].push(c);\n  }\n  return Object.entries(groups)\n    .sort((a, b) =\u003e {\n      const ai = TIMING_ORDER.indexOf(a[0]);\n      const bi = TIMING_ORDER.indexOf(b[0]);\n      return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);\n    })\n    .map(([key, items]) =\u003e ({ timing: key, label: TIMING_LABELS[key] || key, items }));\n}\n\nasync function fetchObjectiveConditions(loanId: string): Promise\u003cConditionItem[]\u003e {\n  try {\n    const config = await getVestaConfig();\n    if (!config.apiUrl || !config.apiKey) { console.error(\"Vesta API not configured for conditions\"); return []; }\n    const baseUrl = config.apiUrl.replace(/\\/+$/, \"\");\n    const url = `${baseUrl}/loans/${encodeURIComponent(loanId)}/objective-conditions`;\n    console.log(`Fetching conditions: ${url}`);\n    const response = await fetch(url, {\n      method: \"GET\",\n      headers: { Accept: \"application/json\", Authorization: `Token ${config.apiKey}`, \"x-Api-Version\": config.apiVersion },\n    });\n    if (!response.ok) { console.error(`Conditions API error (${response.status}): ${await response.text()}`); return []; }\n    const conditions = await response.json();\n    console.log(`Fetched ${Array.isArray(conditions) ? conditions.length : 0} conditions`);\n    return Array.isArray(conditions) ? conditions : [];\n  } catch (err: any) {\n    console.error(\"Failed to fetch conditions:\", err.message);\n    return [];\n  }\n}\n\n// ─── Email Shared Components ─────────────────────────────────────────────────\n\nconst companyName = \"United Fidelity Funding\";\nconst year = new Date().getFullYear();\n\nconst stageChangeIcon = `\u003ctable role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" align=\"center\" style=\"margin-bottom:16px;\"\u003e\u003ctr\u003e\u003ctd style=\"width:64px;height:64px;background-color:rgba(255,255,255,0.15);border-radius:50%;text-align:center;line-height:64px;font-size:32px;\"\u003e\u0026#x1F504;\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e`;\n\n// Outlook-safe button using VML fallback\nfunction outlookButton(url: string, label: string): string {\n  return `\u003ctable role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"margin:28px 0;\"\u003e\u003ctr\u003e\u003ctd align=\"center\"\u003e\n\u003c!--[if mso]\u003e\n\u003cv:roundrect xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:w=\"urn:schemas-microsoft-com:office:word\" href=\"${url}\" style=\"height:48px;v-text-anchor:middle;width:260px;\" arcsize=\"17%\" strokecolor=\"#dc2626\" fillcolor=\"#dc2626\"\u003e\n\u003cw:anchorlock/\u003e\u003ccenter style=\"color:#ffffff;font-family:Arial,sans-serif;font-size:16px;font-weight:bold;\"\u003e${label}\u003c/center\u003e\n\u003c/v:roundrect\u003e\n\u003c![endif]--\u003e\n\u003c!--[if !mso]\u003e\u003c!--\u003e\n\u003ca href=\"${url}\" target=\"_blank\" style=\"display:inline-block;background-color:#dc2626;color:#ffffff;font-family:Arial,sans-serif;font-size:16px;font-weight:700;text-decoration:none;padding:14px 40px;border-radius:8px;letter-spacing:0.3px;mso-hide:all;\"\u003e${label}\u003c/a\u003e\n\u003c!--\u003c![endif]--\u003e\n\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e`;\n}\n\nfunction wrapEmail(heading: string, preheader: string, bodyContent: string, losUrl?: string, buttonLabel?: string): string {\n  return `\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\"\u003e\n\u003chead\u003e\n  \u003cmeta charset=\"UTF-8\"\u003e\n  \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e\n  \u003c!--[if mso]\u003e\u003cxml\u003e\u003co:OfficeDocumentSettings\u003e\u003co:PixelsPerInch\u003e96\u003c/o:PixelsPerInch\u003e\u003co:AllowPNG/\u003e\u003c/o:OfficeDocumentSettings\u003e\u003c/xml\u003e\u003c![endif]--\u003e\n  \u003ctitle\u003e${heading}\u003c/title\u003e\n  \u003cstyle\u003e\n    @media only screen and (max-width: 620px) {\n      .email-container { width: 100% !important; }\n      .email-body { padding: 24px !important; }\n    }\n  \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody style=\"margin:0;padding:0;background-color:#f8f9fa;font-family:Arial,\u0027Helvetica Neue\u0027,Helvetica,sans-serif;\"\u003e\n  \u003cspan style=\"display:none;max-height:0;overflow:hidden;\"\u003e${preheader}\u003c/span\u003e\n  \u003ctable role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"background-color:#f8f9fa;\"\u003e\n    \u003ctr\u003e\n      \u003ctd align=\"center\" style=\"padding:40px 20px;\"\u003e\n        \u003ctable role=\"presentation\" class=\"email-container\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\" bgcolor=\"#ffffff\" style=\"background-color:#ffffff;\"\u003e\n          \u003ctr\u003e\n            \u003ctd bgcolor=\"#dc2626\" style=\"background-color:#dc2626;padding:40px 40px 30px;text-align:center;\"\u003e\n              ${stageChangeIcon}\n              \u003ch1 style=\"color:#ffffff;font-family:Arial,sans-serif;font-size:26px;font-weight:700;margin:0 0 8px;\"\u003e${heading}\u003c/h1\u003e\n              \u003cp style=\"color:#fecaca;font-family:Arial,sans-serif;font-size:15px;margin:0;\"\u003e${preheader}\u003c/p\u003e\n            \u003c/td\u003e\n          \u003c/tr\u003e\n          \u003ctr\u003e\n            \u003ctd class=\"email-body\" style=\"padding:40px;\"\u003e\n              ${bodyContent}\n              ${losUrl ? outlookButton(losUrl, buttonLabel || \"View Loan in LOS \\u2192\") : \"\"}\n              \u003cp style=\"font-family:Arial,sans-serif;font-size:15px;color:#4b5563;margin:0;line-height:1.7;\"\u003eWarm regards,\u003cbr\u003e\u003cstrong style=\"color:#1f2937;\"\u003eThe ${companyName} Team\u003c/strong\u003e\u003c/p\u003e\n            \u003c/td\u003e\n          \u003c/tr\u003e\n          \u003ctr\u003e\n            \u003ctd bgcolor=\"#f9fafb\" style=\"background-color:#f9fafb;padding:24px 40px;border-top:1px solid #e5e7eb;\"\u003e\n              \u003cp style=\"font-family:Arial,sans-serif;font-size:11px;color:#9ca3af;margin:0 0 8px;line-height:1.6;text-align:center;\"\u003e${companyName} Corp., NMLS #34381 | 1300 NW Briarcliff Pkwy #275, Kansas City, MO 64116\u003c/p\u003e\n              \u003cp style=\"font-family:Arial,sans-serif;font-size:11px;color:#9ca3af;margin:0 0 8px;line-height:1.6;text-align:center;\"\u003eLicensed in 39 states. \u003ca href=\"https://www.nmlsconsumeraccess.org/EntityDetails.aspx/COMPANY/34381\" style=\"color:#9ca3af;text-decoration:underline;\"\u003eNMLS Consumer Access\u003c/a\u003e.\u003c/p\u003e\n              \u003cp style=\"font-family:Arial,sans-serif;font-size:11px;color:#9ca3af;margin:0;line-height:1.6;text-align:center;\"\u003eEqual Housing Lender. \u0026copy; ${year} ${companyName} Corp. All rights reserved.\u003c/p\u003e\n            \u003c/td\u003e\n          \u003c/tr\u003e\n        \u003c/table\u003e\n      \u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/table\u003e\n\u003c/body\u003e\n\u003c/html\u003e`;\n}\n\n// ─── Shared: Stage Colors \u0026 Detail Row Builder ───────────────────────────────\n\nconst stageColors: Record\u003cstring, { bg: string; border: string; text: string }\u003e = {\n  \"Prospect\": { bg: \"#f9fafb\", border: \"#6b7280\", text: \"#374151\" },\n  \"Pre-Qualification\": { bg: \"#eff6ff\", border: \"#2563eb\", text: \"#1e40af\" },\n  \"Pre-Approval\": { bg: \"#eff6ff\", border: \"#2563eb\", text: \"#1e40af\" },\n  \"Application\": { bg: \"#eff6ff\", border: \"#2563eb\", text: \"#1e40af\" },\n  \"Processing\": { bg: \"#fefce8\", border: \"#eab308\", text: \"#854d0e\" },\n  \"Underwriting\": { bg: \"#fefce8\", border: \"#eab308\", text: \"#854d0e\" },\n  \"Conditional Approval\": { bg: \"#f0fdf4\", border: \"#16a34a\", text: \"#166534\" },\n  \"Clear to Close\": { bg: \"#f0fdf4\", border: \"#16a34a\", text: \"#166534\" },\n  \"Closing\": { bg: \"#f0fdf4\", border: \"#16a34a\", text: \"#166534\" },\n  \"Funded\": { bg: \"#f0fdf4\", border: \"#16a34a\", text: \"#166534\" },\n  \"Suspended\": { bg: \"#fef2f2\", border: \"#dc2626\", text: \"#991b1b\" },\n  \"Denied\": { bg: \"#fef2f2\", border: \"#dc2626\", text: \"#991b1b\" },\n  \"Withdrawn\": { bg: \"#fef2f2\", border: \"#dc2626\", text: \"#991b1b\" },\n};\n\nfunction detailRow(label: string, value: string): string {\n  if (!value) return \"\";\n  return `\u003ctr\u003e\u003ctd style=\"padding:8px 0;border-bottom:1px solid #e2e8f0;color:#64748b;font-size:13px;\"\u003e${label}\u003c/td\u003e\u003ctd style=\"padding:8px 0;border-bottom:1px solid #e2e8f0;color:#0f172a;font-size:13px;font-weight:600;text-align:right;\"\u003e${value}\u003c/td\u003e\u003c/tr\u003e`;\n}\n\nfunction stageBlock(newStage: string, previousStage?: string): string {\n  const colors = stageColors[newStage] || { bg: \"#eff6ff\", border: \"#2563eb\", text: \"#1e40af\" };\n  return `\u003ctable role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"margin-bottom:24px;\"\u003e\u003ctr\u003e\n    \u003ctd style=\"background-color:${colors.bg};border-left:4px solid ${colors.border};padding:24px;\"\u003e\n      \u003cp style=\"font-family:Arial,sans-serif;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:${colors.text};margin:0 0 4px;\"\u003eNew Loan Stage\u003c/p\u003e\n      \u003cp style=\"font-family:Arial,sans-serif;font-size:24px;font-weight:700;color:${colors.text};margin:0;\"\u003e${newStage}\u003c/p\u003e\n      ${previousStage \u0026\u0026 previousStage !== newStage ? `\u003cp style=\"font-family:Arial,sans-serif;font-size:13px;color:#6b7280;margin:8px 0 0;\"\u003ePreviously: ${previousStage}\u003c/p\u003e` : \"\"}\n    \u003c/td\u003e\n  \u003c/tr\u003e\u003c/table\u003e`;\n}\n\nfunction detailsTable(rows: string): string {\n  return `\u003ctable role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"background-color:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;margin-bottom:24px;\"\u003e\u003ctr\u003e\u003ctd style=\"padding:20px;\"\u003e\n    \u003cp style=\"font-family:Arial,sans-serif;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:#64748b;margin:0 0 12px;\"\u003eLoan Details\u003c/p\u003e\n    \u003ctable role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"\u003e${rows}\u003c/table\u003e\n  \u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e`;\n}\n\nconst apiWarningHtml = `\u003ctable role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"background-color:#fef2f2;border-left:4px solid #dc2626;margin-bottom:24px;\"\u003e\u003ctr\u003e\u003ctd style=\"padding:16px 20px;\"\u003e\u003cp style=\"font-family:Arial,sans-serif;font-size:14px;color:#991b1b;margin:0;line-height:1.6;\"\u003e\u003cstrong\u003eNote:\u003c/strong\u003e Could not fetch full loan details from Vesta API. Only webhook data is shown above.\u003c/p\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e`;\n\n// ═══════════════════════════════════════════════════════════════════════════════\n// ─── CHANNEL-SPECIFIC EMAIL BUILDERS ─────────────────────────────────────────\n// Architecture: Each event type has a builder per channel.\n// Register new event types by adding to the `eventHandlers` map below.\n// ═══════════════════════════════════════════════════════════════════════════════\n\n// ── LoanStageChanged: RETAIL (LO-focused) ────────────────────────────────────\n\nfunction buildRetailStageChanged(webhook: VestaWebhookPayload, loan: LoanDetails | null, losUrl?: string): EmailResult {\n  const newStage = webhook.newLoanStage || \"Unknown\";\n  const loanNumber = loan?.loanNumber || \"\";\n  const borrowerName = loan?.borrowerName || \"Borrower\";\n  const loFirst = loan?.loFullName?.split(\" \")[0] || \"Team\";\n\n  const rows = [\n    detailRow(\"Loan Number\", loanNumber),\n    detailRow(\"Borrower\", borrowerName),\n    detailRow(\"Borrower Email\", loan?.borrowerEmail || \"\"),\n    detailRow(\"Borrower Phone\", loan?.borrowerPhone || \"\"),\n    detailRow(\"Property\", loan?.propertyAddress || \"\"),\n    detailRow(\"Loan Amount\", loan?.loanAmount ? formatCurrency(loan.loanAmount) : \"\"),\n    detailRow(\"Loan Type\", loan?.loanType || \"\"),\n    detailRow(\"Purpose\", loan?.loanPurpose || \"\"),\n    detailRow(\"Updated\", formatTimestamp(webhook.timestamp)),\n  ].join(\"\");\n\n  const body = `\u003cp style=\"font-family:Arial,sans-serif;font-size:17px;color:#1f2937;margin:0 0 16px;line-height:1.6;\"\u003eHi ${loFirst},\u003c/p\u003e\n    \u003cp style=\"font-family:Arial,sans-serif;font-size:15px;color:#4b5563;margin:0 0 24px;line-height:1.7;\"\u003eA loan stage change has occurred${loanNumber ? ` on Loan #\u003cstrong\u003e${loanNumber}\u003c/strong\u003e` : \"\"}. Here are the details:\u003c/p\u003e\n    ${stageBlock(newStage, loan?.loanStage)}\n    ${detailsTable(rows)}\n    ${!loan ? apiWarningHtml : \"\"}`;\n\n  const recipients: string[] = [];\n  if (loan?.loEmail) recipients.push(loan.loEmail);\n\n  return {\n    subject: `Loan Stage Changed: ${newStage}${loanNumber ? ` \\u2014 Loan #${loanNumber}` : \"\"} \\u2014 ${borrowerName}`,\n    html: wrapEmail(\"Loan Stage Changed\", `${borrowerName} \\u2192 ${newStage}`, body, losUrl),\n    recipients,\n  };\n}\n\n// ── LoanStageChanged: WHOLESALE (Broker-focused) ─────────────────────────────\n\nfunction buildWholesaleStageChanged(webhook: VestaWebhookPayload, loan: LoanDetails | null, losUrl?: string): EmailResult {\n  const newStage = webhook.newLoanStage || \"Unknown\";\n  const loanNumber = loan?.loanNumber || \"\";\n  const borrowerName = loan?.borrowerName || \"Borrower\";\n  const brokerFirst = loan?.brokerName?.split(\" \")[0] || \"Partner\";\n\n  const rows = [\n    detailRow(\"Loan Number\", loanNumber),\n    detailRow(\"Borrower\", borrowerName),\n    detailRow(\"Property\", loan?.propertyAddress || \"\"),\n    detailRow(\"Loan Amount\", loan?.loanAmount ? formatCurrency(loan.loanAmount) : \"\"),\n    detailRow(\"Loan Type\", loan?.loanType || \"\"),\n    detailRow(\"Purpose\", loan?.loanPurpose || \"\"),\n    detailRow(\"Broker LO\", loan?.loFullName || \"\"),\n    detailRow(\"LO Email\", loan?.loEmail || \"\"),\n    detailRow(\"LO Phone\", loan?.loPhone || \"\"),\n    detailRow(\"Updated\", formatTimestamp(webhook.timestamp)),\n  ].join(\"\");\n\n  const body = `\u003cp style=\"font-family:Arial,sans-serif;font-size:17px;color:#1f2937;margin:0 0 16px;line-height:1.6;\"\u003eHi ${brokerFirst},\u003c/p\u003e\n    \u003cp style=\"font-family:Arial,sans-serif;font-size:15px;color:#4b5563;margin:0 0 24px;line-height:1.7;\"\u003eA loan you submitted to ${companyName} has moved to a new stage${loanNumber ? ` (Loan #\u003cstrong\u003e${loanNumber}\u003c/strong\u003e)` : \"\"}.\u003c/p\u003e\n    ${stageBlock(newStage, loan?.loanStage)}\n    ${detailsTable(rows)}\n    ${!loan ? apiWarningHtml : \"\"}`;\n\n  const recipients: string[] = [];\n  if (loan?.brokerEmail) recipients.push(loan.brokerEmail);\n\n  return {\n    subject: `[UFF] Stage Update: ${newStage}${loanNumber ? ` \\u2014 Loan #${loanNumber}` : \"\"} \\u2014 ${borrowerName}`,\n    html: wrapEmail(\"Loan Stage Update\", `${borrowerName} \\u2192 ${newStage}`, body, losUrl, \"View Loan in PRO Portal \\u2192\"),\n    recipients,\n  };\n}\n\n// ── UnderwriterDecision: Shared Config ─────────────────────────────────────────\n\ntype Decision = \"ConditionallyApprove\" | \"ClearToClose\" | \"Deny\" | \"Suspend\";\n\ninterface DecisionConfig {\n  heading: string;\n  preheader: (borrowerName: string, loanNumber: string) =\u003e string;\n  subjectPrefix: string;\n  icon: string;\n  headerBg: string;\n  headerTextColor: string;\n  accentColor: string;\n  greetingLine: (firstName: string, loanNumber: string) =\u003e string;\n}\n\nconst decisionConfigs: Record\u003cDecision, DecisionConfig\u003e = {\n  ConditionallyApprove: {\n    heading: \"Conditionally Approved!\",\n    preheader: (b, ln) =\u003e `Great news — Loan #${ln} for ${b} has been conditionally approved`,\n    subjectPrefix: \"Conditionally Approved\",\n    icon: \"\u0026#x1F389;\",\n    headerBg: \"#16a34a\",\n    headerTextColor: \"#ffffff\",\n    accentColor: \"#16a34a\",\n    greetingLine: (f, ln) =\u003e `Great news! Loan${ln ? ` #\u003cstrong\u003e${ln}\u003c/strong\u003e` : \"\"} has been \u003cstrong\u003econditionally approved\u003c/strong\u003e by underwriting. There are conditions that need to be satisfied before we can move forward. Please review the conditions below:`,\n  },\n  ClearToClose: {\n    heading: \"Clear to Close!\",\n    preheader: (b, ln) =\u003e `Exciting — Loan #${ln} for ${b} is Clear to Close!`,\n    subjectPrefix: \"Clear to Close\",\n    icon: \"\u0026#x1F3C1;\",\n    headerBg: \"#059669\",\n    headerTextColor: \"#ffffff\",\n    accentColor: \"#059669\",\n    greetingLine: (f, ln) =\u003e `Incredible news! Loan${ln ? ` #\u003cstrong\u003e${ln}\u003c/strong\u003e` : \"\"} is \u003cstrong\u003eClear to Close\u003c/strong\u003e! This is the final step before closing documents are sent out — the finish line is right around the corner. Here are the remaining items:`,\n  },\n  Deny: {\n    heading: \"Loan Decision: Denied\",\n    preheader: (b, ln) =\u003e `Loan #${ln} for ${b} — Underwriter Decision: Denied`,\n    subjectPrefix: \"Decision: Denied\",\n    icon: \"\u0026#x26D4;\",\n    headerBg: \"#6b7280\",\n    headerTextColor: \"#ffffff\",\n    accentColor: \"#6b7280\",\n    greetingLine: (f, ln) =\u003e `Loan${ln ? ` #\u003cstrong\u003e${ln}\u003c/strong\u003e` : \"\"} has received an underwriting decision of \u003cstrong\u003eDenied\u003c/strong\u003e. Please review the conditions and underwriter notes below for details.`,\n  },\n  Suspend: {\n    heading: \"Loan Decision: Suspended\",\n    preheader: (b, ln) =\u003e `Loan #${ln} for ${b} — Underwriter Decision: Suspended`,\n    subjectPrefix: \"Decision: Suspended\",\n    icon: \"\u0026#x23F8;\u0026#xFE0F;\",\n    headerBg: \"#d97706\",\n    headerTextColor: \"#ffffff\",\n    accentColor: \"#d97706\",\n    greetingLine: (f, ln) =\u003e `Loan${ln ? ` #\u003cstrong\u003e${ln}\u003c/strong\u003e` : \"\"} has been \u003cstrong\u003eSuspended\u003c/strong\u003e by underwriting. This means the file needs additional information or corrections before it can be re-reviewed. Please review the conditions below:`,\n  },\n};\n\nfunction resolveDecision(webhook: VestaWebhookPayload): Decision {\n  const d = webhook.decision || \"\";\n  if (/conditionally/i.test(d)) return \"ConditionallyApprove\";\n  if (/clear/i.test(d)) return \"ClearToClose\";\n  if (/deny|denied/i.test(d)) return \"Deny\";\n  if (/suspend/i.test(d)) return \"Suspend\";\n  return \"ConditionallyApprove\"; // safe fallback\n}\n\n// ── Build conditions HTML grouped by timing ──\n\nfunction buildConditionsHtml(conditions: ConditionItem[], accentColor: string): string {\n  if (!conditions.length) return `\u003cp style=\"font-family:Arial,sans-serif;font-size:14px;color:#64748b;margin:0 0 24px;font-style:italic;\"\u003eNo conditions returned from the system.\u003c/p\u003e`;\n  const groups = groupConditionsByTiming(conditions);\n  let html = \"\";\n  for (const group of groups) {\n    html += `\u003ctable role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"margin-bottom:16px;\"\u003e\n      \u003ctr\u003e\u003ctd style=\"padding:10px 16px;background-color:#f1f5f9;border-left:4px solid ${accentColor};font-family:Arial,sans-serif;font-size:13px;font-weight:700;color:#334155;text-transform:uppercase;letter-spacing:0.5px;\"\u003e${group.label} \u003cspan style=\"font-weight:400;color:#64748b;text-transform:none;letter-spacing:0;\"\u003e(${group.items.length})\u003c/span\u003e\u003c/td\u003e\u003c/tr\u003e`;\n    for (const c of group.items) {\n      const name = c.instructionsOverride || c.externalFacingMessage || c.objectiveName || \"Condition\";\n      const category = c.conditionCategory || c.entityType || \"\";\n      html += `\u003ctr\u003e\u003ctd style=\"padding:10px 16px 10px 28px;border-bottom:1px solid #e2e8f0;\"\u003e\n        \u003cp style=\"font-family:Arial,sans-serif;font-size:14px;color:#1e293b;margin:0 0 4px;line-height:1.5;\"\u003e${name}\u003c/p\u003e\n        ${category ? `\u003cspan style=\"font-family:Arial,sans-serif;font-size:11px;color:#64748b;background-color:#f1f5f9;padding:2px 8px;border-radius:4px;\"\u003e${category}\u003c/span\u003e` : \"\"}\n      \u003c/td\u003e\u003c/tr\u003e`;\n    }\n    html += `\u003c/table\u003e`;\n  }\n  return html;\n}\n\nfunction buildUnderwriterNoteHtml(note: string): string {\n  if (!note) return \"\";\n  return `\u003ctable role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"margin:24px 0;background-color:#fffbeb;border:1px solid #fde68a;border-radius:8px;\"\u003e\n    \u003ctr\u003e\u003ctd style=\"padding:20px;\"\u003e\n      \u003cp style=\"font-family:Arial,sans-serif;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:#92400e;margin:0 0 8px;\"\u003eUnderwriter Notes / Comments\u003c/p\u003e\n      \u003cp style=\"font-family:Arial,sans-serif;font-size:14px;color:#78350f;margin:0;line-height:1.7;white-space:pre-wrap;\"\u003e${note}\u003c/p\u003e\n    \u003c/td\u003e\u003c/tr\u003e\n  \u003c/table\u003e`;\n}\n\n// ── Shared decision email wrapper (overrides header color) ──\n\nfunction wrapDecisionEmail(config: DecisionConfig, preheader: string, bodyContent: string, losUrl?: string, buttonLabel?: string): string {\n  const iconHtml = `\u003ctable role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" align=\"center\" style=\"margin-bottom:16px;\"\u003e\u003ctr\u003e\u003ctd style=\"width:64px;height:64px;background-color:rgba(255,255,255,0.15);border-radius:50%;text-align:center;line-height:64px;font-size:32px;\"\u003e${config.icon}\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e`;\n  return `\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\"\u003e\n\u003chead\u003e\n  \u003cmeta charset=\"UTF-8\"\u003e\n  \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e\n  \u003c!--[if mso]\u003e\u003cxml\u003e\u003co:OfficeDocumentSettings\u003e\u003co:PixelsPerInch\u003e96\u003c/o:PixelsPerInch\u003e\u003co:AllowPNG/\u003e\u003c/o:OfficeDocumentSettings\u003e\u003c/xml\u003e\u003c![endif]--\u003e\n  \u003ctitle\u003e${config.heading}\u003c/title\u003e\n  \u003cstyle\u003e\n    @media only screen and (max-width: 620px) {\n      .email-container { width: 100% !important; }\n      .email-body { padding: 24px !important; }\n    }\n  \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody style=\"margin:0;padding:0;background-color:#f8f9fa;font-family:Arial,\u0027Helvetica Neue\u0027,Helvetica,sans-serif;\"\u003e\n  \u003cspan style=\"display:none;max-height:0;overflow:hidden;\"\u003e${preheader}\u003c/span\u003e\n  \u003ctable role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"background-color:#f8f9fa;\"\u003e\n    \u003ctr\u003e\n      \u003ctd align=\"center\" style=\"padding:40px 20px;\"\u003e\n        \u003ctable role=\"presentation\" class=\"email-container\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\" bgcolor=\"#ffffff\" style=\"background-color:#ffffff;\"\u003e\n          \u003ctr\u003e\n            \u003ctd bgcolor=\"${config.headerBg}\" style=\"background-color:${config.headerBg};padding:40px 40px 30px;text-align:center;\"\u003e\n              ${iconHtml}\n              \u003ch1 style=\"color:${config.headerTextColor};font-family:Arial,sans-serif;font-size:26px;font-weight:700;margin:0 0 8px;\"\u003e${config.heading}\u003c/h1\u003e\n              \u003cp style=\"color:rgba(255,255,255,0.75);font-family:Arial,sans-serif;font-size:15px;margin:0;\"\u003e${preheader}\u003c/p\u003e\n            \u003c/td\u003e\n          \u003c/tr\u003e\n          \u003ctr\u003e\n            \u003ctd class=\"email-body\" style=\"padding:40px;\"\u003e\n              ${bodyContent}\n              ${losUrl ? outlookButton(losUrl, buttonLabel || \"View Loan in LOS \\u2192\") : \"\"}\n              \u003cp style=\"font-family:Arial,sans-serif;font-size:15px;color:#4b5563;margin:0;line-height:1.7;\"\u003eWarm regards,\u003cbr\u003e\u003cstrong style=\"color:#1f2937;\"\u003eThe ${companyName} Team\u003c/strong\u003e\u003c/p\u003e\n            \u003c/td\u003e\n          \u003c/tr\u003e\n          \u003ctr\u003e\n            \u003ctd bgcolor=\"#f9fafb\" style=\"background-color:#f9fafb;padding:24px 40px;border-top:1px solid #e5e7eb;\"\u003e\n              \u003cp style=\"font-family:Arial,sans-serif;font-size:11px;color:#9ca3af;margin:0 0 8px;line-height:1.6;text-align:center;\"\u003e${companyName} Corp., NMLS #34381 | 1300 NW Briarcliff Pkwy #275, Kansas City, MO 64116\u003c/p\u003e\n              \u003cp style=\"font-family:Arial,sans-serif;font-size:11px;color:#9ca3af;margin:0 0 8px;line-height:1.6;text-align:center;\"\u003eLicensed in 39 states. \u003ca href=\"https://www.nmlsconsumeraccess.org/EntityDetails.aspx/COMPANY/34381\" style=\"color:#9ca3af;text-decoration:underline;\"\u003eNMLS Consumer Access\u003c/a\u003e.\u003c/p\u003e\n              \u003cp style=\"font-family:Arial,sans-serif;font-size:11px;color:#9ca3af;margin:0;line-height:1.6;text-align:center;\"\u003eEqual Housing Lender. \u0026copy; ${year} ${companyName} Corp. All rights reserved.\u003c/p\u003e\n            \u003c/td\u003e\n          \u003c/tr\u003e\n        \u003c/table\u003e\n      \u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/table\u003e\n\u003c/body\u003e\n\u003c/html\u003e`;\n}\n\n// ── UnderwriterDecision: RETAIL (LO-focused) ──────────────────────────────────\n\nfunction buildRetailUnderwriterDecision(webhook: VestaWebhookPayload, loan: LoanDetails | null, losUrl?: string, conditions?: ConditionItem[]): EmailResult {\n  const decision = resolveDecision(webhook);\n  const config = decisionConfigs[decision];\n  const loanNumber = loan?.loanNumber || \"\";\n  const borrowerName = loan?.borrowerName || \"Borrower\";\n  const loFirst = loan?.loFullName?.split(\" \")[0] || \"Team\";\n\n  const rows = [\n    detailRow(\"Loan Number\", loanNumber),\n    detailRow(\"Borrower\", borrowerName),\n    detailRow(\"Borrower Email\", loan?.borrowerEmail || \"\"),\n    detailRow(\"Borrower Phone\", loan?.borrowerPhone || \"\"),\n    detailRow(\"Property\", loan?.propertyAddress || \"\"),\n    detailRow(\"Loan Amount\", loan?.loanAmount ? formatCurrency(loan.loanAmount) : \"\"),\n    detailRow(\"Loan Type\", loan?.loanType || \"\"),\n    detailRow(\"Purpose\", loan?.loanPurpose || \"\"),\n    detailRow(\"Decision\", webhook.decision || \"\"),\n    detailRow(\"Updated\", formatTimestamp(webhook.timestamp)),\n  ].join(\"\");\n\n  const preheader = config.preheader(borrowerName, loanNumber);\n  const conditionsHtml = buildConditionsHtml(conditions || [], config.accentColor);\n  const uwNoteHtml = buildUnderwriterNoteHtml(loan?.underwriterNote || \"\");\n\n  const body = `\u003cp style=\"font-family:Arial,sans-serif;font-size:17px;color:#1f2937;margin:0 0 16px;line-height:1.6;\"\u003eHi ${loFirst},\u003c/p\u003e\n    \u003cp style=\"font-family:Arial,sans-serif;font-size:15px;color:#4b5563;margin:0 0 24px;line-height:1.7;\"\u003e${config.greetingLine(loFirst, loanNumber)}\u003c/p\u003e\n    ${detailsTable(rows)}\n    \u003cp style=\"font-family:Arial,sans-serif;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:#64748b;margin:0 0 12px;\"\u003eConditions\u003c/p\u003e\n    ${conditionsHtml}\n    ${uwNoteHtml}\n    ${!loan ? apiWarningHtml : \"\"}`;\n\n  const recipients: string[] = [];\n  if (loan?.loEmail) recipients.push(loan.loEmail);\n\n  return {\n    subject: `${config.subjectPrefix}${loanNumber ? ` \\u2014 Loan #${loanNumber}` : \"\"} \\u2014 ${borrowerName}`,\n    html: wrapDecisionEmail(config, preheader, body, losUrl),\n    recipients,\n  };\n}\n\n// ── UnderwriterDecision: WHOLESALE (Broker-focused) ───────────────────────────\n\nfunction buildWholesaleUnderwriterDecision(webhook: VestaWebhookPayload, loan: LoanDetails | null, losUrl?: string, conditions?: ConditionItem[]): EmailResult {\n  const decision = resolveDecision(webhook);\n  const config = decisionConfigs[decision];\n  const loanNumber = loan?.loanNumber || \"\";\n  const borrowerName = loan?.borrowerName || \"Borrower\";\n  const brokerFirst = loan?.brokerName?.split(\" \")[0] || \"Partner\";\n\n  const rows = [\n    detailRow(\"Loan Number\", loanNumber),\n    detailRow(\"Borrower\", borrowerName),\n    detailRow(\"Property\", loan?.propertyAddress || \"\"),\n    detailRow(\"Loan Amount\", loan?.loanAmount ? formatCurrency(loan.loanAmount) : \"\"),\n    detailRow(\"Loan Type\", loan?.loanType || \"\"),\n    detailRow(\"Purpose\", loan?.loanPurpose || \"\"),\n    detailRow(\"Broker LO\", loan?.loFullName || \"\"),\n    detailRow(\"LO Email\", loan?.loEmail || \"\"),\n    detailRow(\"LO Phone\", loan?.loPhone || \"\"),\n    detailRow(\"Decision\", webhook.decision || \"\"),\n    detailRow(\"Updated\", formatTimestamp(webhook.timestamp)),\n  ].join(\"\");\n\n  const preheader = config.preheader(borrowerName, loanNumber);\n  const conditionsHtml = buildConditionsHtml(conditions || [], config.accentColor);\n  const uwNoteHtml = buildUnderwriterNoteHtml(loan?.underwriterNote || \"\");\n\n  const body = `\u003cp style=\"font-family:Arial,sans-serif;font-size:17px;color:#1f2937;margin:0 0 16px;line-height:1.6;\"\u003eHi ${brokerFirst},\u003c/p\u003e\n    \u003cp style=\"font-family:Arial,sans-serif;font-size:15px;color:#4b5563;margin:0 0 24px;line-height:1.7;\"\u003e${config.greetingLine(brokerFirst, loanNumber)}\u003c/p\u003e\n    ${detailsTable(rows)}\n    \u003cp style=\"font-family:Arial,sans-serif;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:#64748b;margin:0 0 12px;\"\u003eConditions\u003c/p\u003e\n    ${conditionsHtml}\n    ${uwNoteHtml}\n    ${!loan ? apiWarningHtml : \"\"}`;\n\n  const recipients: string[] = [];\n  if (loan?.brokerEmail) recipients.push(loan.brokerEmail);\n\n  return {\n    subject: `[UFF] ${config.subjectPrefix}${loanNumber ? ` \\u2014 Loan #${loanNumber}` : \"\"} \\u2014 ${borrowerName}`,\n    html: wrapDecisionEmail(config, preheader, body, losUrl, \"View Loan in PRO Portal \\u2192\"),\n    recipients,\n  };\n}\n\n// ═══════════════════════════════════════════════════════════════════════════════\n// ─── EVENT HANDLER REGISTRY ──────────────────────────────────────────────────\n// Add new event types here. Each entry maps eventType → { Retail, Wholesale }.\n// ═══════════════════════════════════════════════════════════════════════════════\n\ntype EmailBuilder = (webhook: VestaWebhookPayload, loan: LoanDetails | null, losUrl?: string, conditions?: ConditionItem[]) =\u003e EmailResult;\n\nconst eventHandlers: Record\u003cstring, Partial\u003cRecord\u003cChannel, EmailBuilder\u003e\u003e\u003e = {\n  LoanStageChanged: {\n    Retail: buildRetailStageChanged,\n    Wholesale: buildWholesaleStageChanged,\n  },\n  UnderwriterDecision: {\n    Retail: buildRetailUnderwriterDecision,\n    Wholesale: buildWholesaleUnderwriterDecision,\n  },\n  // Future event types go here, e.g.:\n  // LoanConditionAdded: { Retail: buildRetailConditionAdded, Wholesale: buildWholesaleConditionAdded },\n};\n\n// ─── Send Email via Resend ───────────────────────────────────────────────────\n\nasync function sendEmail(\n  resendApiKey: string, to: string[], subject: string, html: string, replyTo?: string\n): Promise\u003c{ success: boolean; id?: string; error?: string }\u003e {\n  try {\n    const res = await fetch(\"https://api.resend.com/emails\", {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\", Authorization: `Bearer ${resendApiKey}` },\n      body: JSON.stringify({ from: `${companyName} \u003cnoreply@uff.loans\u003e`, to, subject, html, reply_to: replyTo || undefined }),\n    });\n    const result = await res.json();\n    if (!res.ok) { console.error(\"Resend error:\", result); return { success: false, error: result.message || `Resend HTTP ${res.status}` }; }\n    return { success: true, id: result.id };\n  } catch (err: any) {\n    console.error(\"Resend fetch error:\", err);\n    return { success: false, error: err.message };\n  }\n}\n\n// ─── Log webhook event to Supabase ───────────────────────────────────────────\n\nasync function logWebhookEvent(\n  eventType: string, channel: string, rawPayload: Record\u003cstring, any\u003e,\n  loanDetails: LoanDetails | null, emailsSent: string[], errors: string[]\n) {\n  try {\n    const supabase = createClient(Deno.env.get(\"SUPABASE_URL\")!, Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!);\n    await supabase.from(\"webhook_events\").insert({\n      source: \"vesta\",\n      event_type: eventType,\n      loan_id: rawPayload.loanId || null,\n      loan_number: loanDetails?.loanNumber || null,\n      payload: {\n        webhook: rawPayload,\n        channel,\n        loanDetails: loanDetails ? {\n          loanNumber: loanDetails.loanNumber,\n          channel: loanDetails.channel,\n          borrowerName: loanDetails.borrowerName,\n          borrowerEmail: loanDetails.borrowerEmail,\n          loFullName: loanDetails.loFullName,\n          loEmail: loanDetails.loEmail,\n          brokerName: loanDetails.brokerName,\n          brokerEmail: loanDetails.brokerEmail,\n          brokerCompany: loanDetails.brokerCompany,\n          propertyAddress: loanDetails.propertyAddress,\n          loanAmount: loanDetails.loanAmount,\n          loanType: loanDetails.loanType,\n          loanStage: loanDetails.loanStage,\n        } : null,\n        rawLoanKeys: loanDetails?.raw ? Object.keys(loanDetails.raw) : null,\n      },\n      emails_sent: emailsSent,\n      errors: errors.length \u003e 0 ? errors : null,\n      received_at: new Date().toISOString(),\n    });\n  } catch (err) {\n    console.error(\"Failed to log webhook event:\", err);\n  }\n}\n\n// ─── Main Handler ────────────────────────────────────────────────────────────\n\nDeno.serve(async (req: Request) =\u003e {\n  if (req.method !== \"POST\") return jsonResponse({ error: \"Method not allowed\" }, 405);\n\n  // NOTE: Vesta does not send custom auth headers on webhooks.\n\n  let rawPayload: Record\u003cstring, any\u003e;\n  try { rawPayload = await req.json(); } catch { return jsonResponse({ error: \"Invalid JSON body\" }, 400); }\n\n  const eventType = rawPayload.type || rawPayload.Type || rawPayload.eventType || rawPayload.EventType || rawPayload.event_type;\n  if (!eventType) {\n    console.error(\"No event type found:\", JSON.stringify(rawPayload).slice(0, 1000));\n    await logWebhookEvent(\"UNKNOWN\", \"Unknown\", rawPayload, null, [], [\"No event type field found\"]);\n    return jsonResponse({ error: \"Missing event type\", logged: true }, 400);\n  }\n\n  const loanId = rawPayload.loanId || rawPayload.LoanId || \"\";\n  console.log(`Vesta webhook: ${eventType}, loanId: ${loanId}, channel: ${rawPayload.loanChannel || \"?\"}`);\n\n  const resendApiKey = Deno.env.get(\"RESEND_API_KEY\");\n  if (!resendApiKey) {\n    console.error(\"RESEND_API_KEY not configured\");\n    await logWebhookEvent(eventType, \"Unknown\", rawPayload, null, [], [\"RESEND_API_KEY missing\"]);\n    return jsonResponse({ received: true, error: \"Email service not configured\" }, 200);\n  }\n\n  const emailsSent: string[] = [];\n  const errors: string[] = [];\n  const companyEmail = Deno.env.get(\"COMPANY_EMAIL\") || \"mark.ramirez@uff.loans\";\n\n  // Fetch loan details\n  let loan: LoanDetails | null = null;\n  if (loanId) {\n    loan = await fetchLoanDetails(loanId);\n    if (!loan) errors.push(\"Could not fetch loan details from Vesta API\");\n  }\n\n  const channel = resolveChannel(rawPayload as VestaWebhookPayload, loan);\n  console.log(`Resolved channel: ${channel}`);\n\n  // Get Vesta LOS URL for button\n  const vestaConfig = await getVestaConfig();\n  const losUrl = getVestaLoanUrl(vestaConfig.apiUrl, loanId);\n\n  // Fetch conditions for event types that need them\n  const needsConditions = [\"UnderwriterDecision\"];\n  let conditions: ConditionItem[] = [];\n  if (needsConditions.includes(eventType) \u0026\u0026 loanId) {\n    conditions = await fetchObjectiveConditions(loanId);\n    console.log(`Fetched ${conditions.length} conditions for ${eventType}`);\n  }\n\n  // ── Dispatch to channel-specific handler ──\n  const handlers = eventHandlers[eventType];\n  if (handlers) {\n    const builder = handlers[channel] || handlers[\"Retail\"]; // fallback to Retail for Unknown\n    if (builder) {\n      const email = builder(rawPayload as VestaWebhookPayload, loan, losUrl, conditions);\n\n      // Send to channel-specific recipients\n      const sent = new Set\u003cstring\u003e();\n      for (const addr of email.recipients) {\n        if (!addr || sent.has(addr.toLowerCase())) continue;\n        sent.add(addr.toLowerCase());\n        const result = await sendEmail(resendApiKey, [addr], email.subject, email.html);\n        if (result.success) emailsSent.push(`${channel.toLowerCase()}:${addr}`);\n        else errors.push(`${addr} failed: ${result.error}`);\n      }\n\n      // Send to company email (skip if already sent to that address)\n      if (!sent.has(companyEmail.toLowerCase())) {\n        const companyResult = await sendEmail(resendApiKey, [companyEmail], email.subject, email.html);\n        if (companyResult.success) emailsSent.push(`company:${companyEmail}`);\n        else errors.push(`company email failed: ${companyResult.error}`);\n      }\n\n      await logWebhookEvent(eventType, channel, rawPayload, loan, emailsSent, errors);\n      return jsonResponse({\n        received: true, eventType, channel,\n        decision: rawPayload.decision || undefined,\n        newLoanStage: rawPayload.newLoanStage || undefined,\n        loanNumber: loan?.loanNumber || null,\n        conditionsCount: conditions.length || undefined,\n        emailsSent: emailsSent.length,\n        errors: errors.length \u003e 0 ? errors : undefined,\n      });\n    }\n  }\n\n  // ── Fallback for unregistered event types ──\n  const fallbackSubject = `[Vesta] ${eventType}${loan?.loanNumber ? ` \\u2014 Loan #${loan.loanNumber}` : \"\"} \\u2014 ${loan?.borrowerName || \"Unknown\"}`;\n  const fallbackHtml = wrapEmail(\n    \"Vesta Event Received\", `Event: ${eventType}`,\n    `\u003cp style=\"font-family:Arial,sans-serif;font-size:15px;color:#334155;margin:0 0 16px;\"\u003eA \u003cstrong\u003e${eventType}\u003c/strong\u003e event was received from Vesta.\u003c/p\u003e\n    ${detailsTable([\n      detailRow(\"Event\", eventType),\n      detailRow(\"Channel\", channel),\n      detailRow(\"Loan #\", loan?.loanNumber || \"\"),\n      detailRow(\"Borrower\", loan?.borrowerName || \"\"),\n    ].join(\"\"))}\n    \u003cp style=\"font-family:Arial,sans-serif;font-size:13px;color:#94a3b8;margin:0;\"\u003eReceived at ${new Date().toISOString()}\u003c/p\u003e`,\n    losUrl\n  );\n  const result = await sendEmail(resendApiKey, [companyEmail], fallbackSubject, fallbackHtml);\n  if (result.success) emailsSent.push(`company:${companyEmail}`);\n  else errors.push(`company email failed: ${result.error}`);\n\n  await logWebhookEvent(eventType, channel, rawPayload, loan, emailsSent, errors);\n  return jsonResponse({ received: true, eventType, channel, emailsSent: emailsSent.length, errors: errors.length \u003e 0 ? errors : undefined });\n});\n"}